name: Multi-arch Nix2Container CI

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-push:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
            system: x86_64-linux
            tag_suffix: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
            system: aarch64-linux
            tag_suffix: arm64

    runs-on: ${{ matrix.runner }}
    env:
      IMAGE1: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-mcp
      IMAGE2: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-dashboard-mcp

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push juspay-mcp image
        run: |
          nix run .#docker.copyToDockerDaemon --system ${{ matrix.system }}
          docker tag juspay-mcp:latest $IMAGE1:${{ github.ref_name }}-${{ matrix.tag_suffix }}
          docker push $IMAGE1:${{ github.ref_name }}-${{ matrix.tag_suffix }}

      - name: Build and push juspay-mcp for sse
        run: |
          nix run .#docker-sse.copyToDockerDaemon --system ${{ matrix.system }}
          docker tag juspay-mcp-sse:latest $IMAGE1:sse-${{ github.ref_name }}-${{ matrix.tag_suffix }}
          docker push $IMAGE1:sse-${{ github.ref_name }}-${{ matrix.tag_suffix }}

      - name: Build and push juspay-dashboard-mcp
        run: |
          nix run .#docker-dashboard.copyToDockerDaemon --system ${{ matrix.system }}
          docker tag juspay-dashboard-mcp:latest $IMAGE2:${{ github.ref_name }}-${{ matrix.tag_suffix }}
          docker push $IMAGE2:${{ github.ref_name }}-${{ matrix.tag_suffix }}

      - name: Build and push juspay-dashboard-mcp for sse
        run: |
          nix run .#docker-dashboard-sse.copyToDockerDaemon --system ${{ matrix.system }}
          docker tag juspay-dashboard-mcp-sse:latest $IMAGE2:sse-${{ github.ref_name }}-${{ matrix.tag_suffix }}
          docker push $IMAGE2:sse-${{ github.ref_name }}-${{ matrix.tag_suffix }}

  manifest:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      IMAGE1: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-mcp
      IMAGE2: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-dashboard-mcp

    steps:
      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Create and push multi-arch manifest for juspay-mcp and sse
        run: |
          docker manifest create $IMAGE1:latest \
            --amend $IMAGE1:${{ github.ref_name }}-amd64 \
            --amend $IMAGE1:${{ github.ref_name }}-arm64
          docker manifest push $IMAGE1:latest
          docker manifest create $IMAGE1:sse-latest \
            --amend $IMAGE1:sse-${{ github.ref_name }}-amd64 \
            --amend $IMAGE1:sse-${{ github.ref_name }}-arm64
          docker manifest push $IMAGE1:sse-latest

      - name: Create and push multi-arch manifest for juspay-dashboard-mcp and sse
        run: |
          docker manifest create $IMAGE2:latest \
            --amend $IMAGE2:${{ github.ref_name }}-amd64 \
            --amend $IMAGE2:${{ github.ref_name }}-arm64
          docker manifest push $IMAGE2:latest
          docker manifest create $IMAGE2:sse-latest \
            --amend $IMAGE2:${{ github.ref_name }}-amd64 \
            --amend $IMAGE2:${{ github.ref_name }}-arm64
          docker manifest push $IMAGE2:sse-latest
