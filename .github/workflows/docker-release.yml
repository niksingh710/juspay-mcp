name: Release Docker Images

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-push:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
            system: x86_64-linux
            tag_suffix: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
            system: aarch64-linux
            tag_suffix: arm64

    runs-on: ${{ matrix.runner }}
    env:
      IMAGE_MCP: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-mcp
      IMAGE_DASHBOARD: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-dashboard-mcp

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push all images
        run: |
          # Function to build, tag and push images for releases
          build_and_push_release() {
            local nix_target="$1"
            local source_tag="$2"
            local target_image="$3"
            local tag_prefix="$4"
            local version="${{ github.ref_name }}"
            local arch_suffix="${{ matrix.tag_suffix }}"

            local final_tag="${tag_prefix}${version}-${arch_suffix}"

            echo "Building and pushing $source_tag -> $target_image:$final_tag"
            nix run .#${nix_target}.copyToDockerDaemon --system ${{ matrix.system }}
            docker tag ${source_tag}:latest ${target_image}:${final_tag}
            docker push ${target_image}:${final_tag}
          }

          # Build and push all images
          build_and_push_release "docker" "juspay-mcp" "$IMAGE_MCP" ""
          build_and_push_release "docker-sse" "juspay-mcp-sse" "$IMAGE_MCP" "sse-"
          build_and_push_release "docker-dashboard" "juspay-dashboard-mcp" "$IMAGE_DASHBOARD" ""
          build_and_push_release "docker-dashboard-sse" "juspay-dashboard-mcp-sse" "$IMAGE_DASHBOARD" "sse-"

  manifest:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      IMAGE_MCP: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-mcp
      IMAGE_DASHBOARD: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-dashboard-mcp

    steps:
      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Create and push multi-arch manifests
        run: |
          # Function to create and push multi-arch manifest for releases
          create_release_manifest() {
            local image="$1"
            local tag="$2"
            local tag_prefix="$3"
            local version="${{ github.ref_name }}"

            local amd64_tag="${tag_prefix}${version}-amd64"
            local arm64_tag="${tag_prefix}${version}-arm64"

            echo "Creating manifest for $image:$tag"
            docker manifest create ${image}:${tag} \
              --amend ${image}:${amd64_tag} \
              --amend ${image}:${arm64_tag}
            docker manifest push ${image}:${tag}
          }

          # Create manifests for all images
          create_release_manifest "$IMAGE_MCP" "latest" ""
          create_release_manifest "$IMAGE_MCP" "sse-latest" "sse-"
          create_release_manifest "$IMAGE_DASHBOARD" "latest" ""
          create_release_manifest "$IMAGE_DASHBOARD" "sse-latest" "sse-"
