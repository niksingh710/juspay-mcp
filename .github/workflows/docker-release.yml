name: Multi-arch Nix2Container CI

on:
  push:
    branches:
      - "nixify/docker-ci"
    tags:
      - "v*"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE1: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-mcp
      IMAGE2: ${{ secrets.DOCKERHUB_NAMESPACE }}/juspay-dashboard-mcp

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Set up QEMU (for ARM64 emulation)
        uses: docker/setup-qemu-action@v3

      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # Build and push AMD64 images
      - name: Build and push AMD64 images
        run: |
          nix build .#docker.copyToDockerDaemon --system x86_64-linux
          docker tag juspay-mcp:latest $IMAGE1:latest-amd64
          docker push $IMAGE1:latest-amd64

          nix build .#docker-dashboard.copyToDockerDaemon --system x86_64-linux
          docker tag juspay-dashboard-mcp:latest $IMAGE2:latest-amd64
          docker push $IMAGE2:latest-amd64

      # Build and push ARM64 images
      - name: Build and push ARM64 images
        run: |
          nix build .#docker.copyToDockerDaemon --system aarch64-linux
          docker tag juspay-mcp:latest $IMAGE1:latest-arm64
          docker push $IMAGE1:latest-arm64

          nix build .#docker-dashboard.copyToDockerDaemon --system aarch64-linux
          docker tag juspay-dashboard-mcp:latest $IMAGE2:latest-arm64
          docker push $IMAGE2:latest-arm64

      # Create and push multi-arch manifests
      - name: Create and push multi-arch manifests
        run: |
          docker manifest create $IMAGE1:latest \
            --amend $IMAGE1:latest-amd64 \
            --amend $IMAGE1:latest-arm64
          docker manifest push $IMAGE1:latest

          docker manifest create $IMAGE2:latest \
            --amend $IMAGE2:latest-amd64 \
            --amend $IMAGE2:latest-arm64
          docker manifest push $IMAGE2:latest
